<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Buyer Profile | MyStockBD</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

<style>
:root {
  --primary: #ff0000;
  --primary-light: #ff5e00;
  --bg: #f5f6f8;
  --card: #fff;
  --text: #1a1a1a;
  --muted: #666;
  --radius: 14px;
}

/* Reset */
* { 
  box-sizing: border-box; 
  margin: 0; 
  padding: 0; 

  /* üîπ ‡¶∏‡¶¨ element select/copy ‡¶¨‡¶®‡ßç‡¶ß */
  -webkit-user-select: none;  
  -moz-user-select: none;     
  -ms-user-select: none;      
  user-select: none;          
  -webkit-touch-callout: none; 
}

/* üîπ ‡¶∂‡ßÅ‡¶ß‡ßÅ input ‡¶Ü‡¶∞ textarea-‡¶§‡ßá select allow ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
input, textarea {
  -webkit-user-select: text;
  -moz-user-select: text;
  -ms-user-select: text;
  user-select: text;
}

body { 
  font-family: 'Poppins', sans-serif; 
  background: var(--bg); 
  color: var(--text); 
  padding-bottom: 80px; 
}


.topbar {
  background: var(--card);
  padding: 14px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  z-index: 10;
}
.brand { font-size: 18px; font-weight: 600; color: var(--primary); }
.icon-btn { cursor: pointer; color: var(--primary); font-size: 22px; padding: 6px; border-radius: 50%; transition: background 0.2s; }
.icon-btn:hover { background: rgba(0,0,0,0.05); }

.container { padding: 16px; max-width: 480px; margin: auto; }
.loader { border: 6px solid #f3f3f3; border-top: 6px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 80px auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.profile-card {
  background: var(--card);
  border-radius: 20px;
  padding: 20px;
  box-shadow: 0 8px 22px rgba(0,0,0,0.12);
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 20px;
  transition: box-shadow 0.2s;
}
.profile-card:hover { box-shadow: 0 10px 28px rgba(0,0,0,0.16); }

.avatar {
  width: 80px;
  height: 80px;
  aspect-ratio: 1 / 1;   /* üîπ ‡¶∏‡¶∞‡ßç‡¶¨‡¶¶‡¶æ ‡¶∏‡ßç‡¶ï‡ßã‡ßü‡¶æ‡¶∞ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
  border-radius: 50%;    /* üîπ ‡¶è‡¶ü‡¶æ‡¶ï‡ßá ‡¶ó‡ßã‡¶≤ ‡¶ï‡¶∞‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá */
  background: var(--primary-light);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 28px;
  font-weight: bold;
  flex-shrink: 0;        /* üîπ ‡¶ö‡¶æ‡¶™‡¶æ ‡¶™‡ßú‡¶¨‡ßá ‡¶®‡¶æ */
  object-fit: cover;     /* üîπ ‡¶õ‡¶¨‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞‡¶≠‡¶æ‡¶¨‡ßá fit ‡¶π‡¶¨‡ßá */
}
.user-info { flex: 1; }
.user-info h2 { font-size: 18px; margin-bottom: 6px; font-weight: 600; }
.user-info p { font-size: 14px; color: #666; }

.section {
  background: var(--card);
  border-radius: 20px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.12);
  border: 1px solid #eee;
}

.order {
  border-radius: 18px;
  padding: 16px 20px;
  margin-bottom: 16px;
  font-size: 14px;
  color: #333;
  background: linear-gradient(145deg, #ffffff, #f9f9f9);
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  transition: all 0.25s ease;
  position: relative;
  overflow: hidden;
}
.order:hover { box-shadow: 0 10px 28px rgba(0,0,0,0.16); }
.order strong { font-size:16px; color: var(--primary); margin-bottom:8px; display:block; }

.status {
  margin-top:10px; display:inline-flex; align-items:center; gap:6px; 
  padding:6px 14px; border-radius:25px; font-size:13px; font-weight:600; color:#fff; text-transform:capitalize; 
}
.delivered { background: linear-gradient(90deg, #4caf50, #66bb6a); }
.pending { background: linear-gradient(90deg, #ff9800, #ffb74d); }
.processing { background: linear-gradient(90deg, #ff5900, #ff7a33); }
.cancel { background: linear-gradient(90deg, #f44336, #ef5350); }
.status .material-icons-outlined { font-size:16px; }

.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--card); border-top: 1px solid #eee;
  display: flex; justify-content: space-around;
  padding: 8px 0; box-shadow: 0 -2px 6px rgba(0,0,0,0.05);
}
.bottom-nav div {
  text-align: center; font-size: 12px; color: #666;
  cursor: pointer; display: flex; flex-direction: column; align-items: center;
}
.bottom-nav .active { color: var(--primary); font-weight: 600; }
.material-icons-outlined { font-size: 20px; display: block; cursor: pointer; }

#imgModal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.8);
  justify-content: center; align-items: center;
}
#imgModal img {
  max-width: 90%; max-height: 80%;
  border-radius: 10px;
}
#closeModal {
  position: absolute; top: 20px; right: 30px;
  font-size: 40px; color: #fff; cursor: pointer;
}
</style>
</head>
<body>

<div class="topbar">
  <span class="brand" id="storeName"></span>
  <span class="material-icons-outlined icon-btn" onclick="logout()">logout</span>
</div>

<div class="container">
  <div id="loader" class="loader"></div>

  <div id="profileContent" style="display:none;">
    <div class="profile-card">
      <div class="avatar" id="avatar">U</div>
      <div class="user-info">
        <h2 id="userName">Loading...</h2>
        <p id="userEmail">Loading...</p>
      </div>
      <span class="material-icons-outlined icon-btn" onclick="editName()">edit</span>
    </div>

    <div class="section">
      <div id="orderBox" style="min-height:120px;">
        <div id="orderList" style="font-size:14px; color:#444; text-align:center;">
          ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div id="imgModal">
  <span id="closeModal">&times;</span>
  <img id="modalImg" src="">
</div>

<div class="bottom-nav">
  <div onclick="goToHome()"><span class="material-icons-outlined">home</span>Home</div>
  <div onclick="openFavourites()"><span class="material-icons-outlined">favorite</span>Favourites</div>
  <div onclick="openCart()"><span class="material-icons-outlined">shopping_cart</span>Cart</div>
  <div class="active"><span class="material-icons-outlined">person</span>Profile</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBuGBZ9wJ2i29fIR2YjtUHqAqa58hkKXug",
  authDomain: "mystockbd-2562f.firebaseapp.com",
  projectId: "mystockbd-2562f",
  storageBucket: "mystockbd-2562f.appspot.com",
  messagingSenderId: "502104908886",
  appId: "1:502104908886:web:ec887afe724c0f1a2f87f7",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const urlParams = new URLSearchParams(window.location.search);
const storeId = urlParams.get("storeId");

async function loadSellerName(storeId){
  if(!storeId) return;
  const sellerId = storeId.replace("store_", "");
  const sellerDoc = await db.collection("sellers").doc(sellerId).get();
  if(sellerDoc.exists){
    document.getElementById("storeName").textContent = sellerDoc.data().name || "Seller";
  }
}

auth.onAuthStateChanged(async user => {
  if(!user) {
    console.log("No user, redirecting...");
    window.location.href = storeId ? `buyer-login.html?storeId=${storeId}` : 'buyer-login.html';
    return;
  }

  console.log("User logged in:", user.uid);

  loadSellerName(storeId);

  try {
    const docSnap = await db.collection('users').doc(user.uid).get();
    console.log("Doc exists:", docSnap.exists, "Data:", docSnap.data());

    if(!docSnap.exists){
      alert("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
      await auth.signOut();
      window.location.href = storeId ? `buyer-login.html?storeId=${storeId}` : 'buyer-login.html';
      return;
    }

    if(docSnap.data().role !== 'buyer'){
      alert("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ Buyer ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®!");
      await auth.signOut();
      window.location.href = storeId ? `buyer-login.html?storeId=${storeId}` : 'buyer-login.html';
      return;
    }

    // ‚úÖ ‡¶∏‡¶¨ ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡¶≤‡ßá
    const data = docSnap.data();
    document.getElementById('userName').innerText = data.name || user.email.split('@')[0];
    document.getElementById('userEmail').innerText = data.email || user.email;
    document.getElementById('avatar').innerText = (data.name || 'U').charAt(0).toUpperCase();

    loadOrders(user.uid);

    document.getElementById('loader').style.display='none';
    document.getElementById('profileContent').style.display='block';

  } catch(err){
    console.error("Firestore error:", err);
  }
});


async function editName(){
  const newName = prompt("‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:");
  if(!newName) return;
  const user = auth.currentUser;
  if(!user) return;
  try {
    await db.collection("users").doc(user.uid).update({ name: newName });
    document.getElementById("userName").innerText = newName;
    document.getElementById("avatar").innerText = newName.charAt(0).toUpperCase();
    alert("‡¶®‡¶æ‡¶Æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá ‚úÖ");
  } catch (error) {
    console.error("Error updating name: ", error);
    alert("‡¶®‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
  }
}

// üîπ Load Orders with formatted date & image modal
function loadOrders(uid){
  const orderList = document.getElementById('orderList');
  if(!storeId) {
    orderList.innerHTML = '<p>‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§</p>';
    return;
  }

  const statusMap = {
    delivered: {class:'delivered', icon:'check_circle'},
    pending: {class:'pending', icon:'hourglass_bottom'},
    processing: {class:'processing', icon:'hourglass_top'},
    cancelled: {class:'cancel', icon:'cancel'} // lowercase key
  };

  db.collection('users').doc(uid).collection('orders')
    .orderBy('createdAt', 'desc')
    .onSnapshot(snapshot => {
      if(snapshot.empty) {
        orderList.innerHTML='<p>‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶®‡ßá‡¶á‡•§</p>';
        return;
      }
      
      orderList.innerHTML = '';
      let hasOrders = false;

      snapshot.forEach(doc => {
        const order = doc.data();
        if(order.storeId !== storeId) return;

        hasOrders = true;
        const status = (order.status || 'pending').toLowerCase();
        const {class: statusClass, icon} = statusMap[status] || statusMap['pending'];

        const orderDate = order.createdAt && order.createdAt.toDate ? order.createdAt.toDate() : new Date();
        const months = ["‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø","‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø","‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö","‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤","‡¶Æ‡ßá","‡¶ú‡ßÅ‡¶®","‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á","‡¶Ö‡¶ó‡¶æ‡¶∏‡ßç‡¶ü","‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞","‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞","‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞","‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞"];
        let hours = orderDate.getHours();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12 || 12;
        const minutes = orderDate.getMinutes().toString().padStart(2,'0');
        const formattedDate = `${orderDate.getDate()} ${months[orderDate.getMonth()]} ${orderDate.getFullYear()}, ${hours}:${minutes} ${ampm}`;

        const address = `${order.division || ''}, ${order.district || ''}, ${order.upazila || ''}, ${order.postal || ''}`;

        const itemsHtml = (order.items || []).map(item =>
          `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
             <div style="display:flex; align-items:center; gap:8px; cursor:pointer;" onclick="openImage('${item.mainImage}')">
               <img src="${item.mainImage}" alt="${item.name}" style="width:50px; height:50px; border-radius:8px; object-fit:cover;">
               <span>${item.name} √ó ${item.qty}</span>
             </div>
             <span>‡ß≥${item.price}</span>
           </div>`).join('');

        const div = document.createElement('div');
        div.className = 'order';
        div.innerHTML = `
          <strong>‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ #${doc.id}</strong>
          <div style="font-size:12px; color:#888; margin-bottom:8px;">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${formattedDate}</div>
          <div style="margin:10px 0;">${itemsHtml}</div>
          <div style="display:flex; justify-content:space-between; font-weight:600; margin-bottom:6px;">
            <span>‡¶Æ‡ßã‡¶ü ‡¶¶‡¶æ‡¶Æ:</span>
            <span>‡ß≥${order.totalPrice}</span>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:13px; color:#555; margin-bottom:6px;">
            <span>‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ:</span>
            <span>${address || '‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶π‡ßü‡¶®‡¶ø'}</span>
          </div>
          <span class="status ${statusClass}">
            <span class="material-icons-outlined">${icon}</span>
            ${statusClass}
          </span>
        `;
        orderList.appendChild(div);
      });

      if(!hasOrders){
        orderList.innerHTML = '<p>‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá‡¶®‡¶®‡¶ø‡•§</p>';
      }
    });
}

// üîπ Image modal functions
function openImage(src){
  document.getElementById('modalImg').src = src;
  document.getElementById('imgModal').style.display = 'flex';
}
document.getElementById('closeModal').onclick = () => {
  document.getElementById('imgModal').style.display = 'none';
};

function goToHome(){ window.location.href = storeId ? `index.html?storeId=${storeId}` : 'index.html'; }
function openFavourites(){ window.location.href = storeId ? `favourite.html?storeId=${storeId}` : 'favourite.html'; }
function openCart(){ window.location.href = storeId ? `cart.html?storeId=${storeId}` : 'cart.html'; }
function logout(){ auth.signOut(); window.location.href = storeId ? `buyer-login.html?storeId=${storeId}` : 'buyer-login.html'; }
</script>

</body>
</html>
