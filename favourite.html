<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MyStockBD ‚Äî Favourites</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
<style>
:root{
  --primary:#ff0000;
  --bg:#f4f4f4;
  --card:#fff;
  --text:#333;
  --muted:#777;
  --radius:12px;
  --shadow:0 4px 12px rgba(0,0,0,0.08);
}
/* Reset */
* { 
  box-sizing: border-box; 
  margin: 0; 
  padding: 0; 

  /* üîπ ‡¶∏‡¶¨ element select/copy ‡¶¨‡¶®‡ßç‡¶ß */
  -webkit-user-select: none;  
  -moz-user-select: none;     
  -ms-user-select: none;      
  user-select: none;          
  -webkit-touch-callout: none; 
}

/* üîπ ‡¶∂‡ßÅ‡¶ß‡ßÅ input ‡¶Ü‡¶∞ textarea-‡¶§‡ßá select allow ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
input, textarea {
  -webkit-user-select: text;
  -moz-user-select: text;
  -ms-user-select: text;
  user-select: text;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Poppins',sans-serif;background:var(--bg);color:var(--text);padding-bottom:80px;}
header{position:relative;padding:20px;background:var(--primary);color:#fff;display:flex;align-items:center;gap:10px;}
header h1{font-size:20px;}
header .back-arrow{cursor:pointer;}
.product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;padding:12px;}
.product-card{background:var(--card);border-radius:var(--radius);overflow:hidden;position:relative;display:flex;flex-direction:column;transition:0.3s;cursor:pointer;}
.product-card:hover{border:1px solid var(--primary);box-shadow:0 4px 12px rgba(0,0,0,0.1);}
.product-image-wrapper{position:relative;width:100%;height:160px;}
.product-image-wrapper img{width:100%;height:100%;object-fit:cover;}
.favorite-icon{position:absolute;top:8px;right:8px;color:var(--primary);cursor:pointer;font-size:22px;transition:0.2s;}
.favorite-icon:hover{transform:scale(1.2);}
.product-info{padding:8px;display:flex;flex-direction:column;gap:4px;}
.product-info h3{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.price{font-weight:bold;color:#e60000;font-size:14px;}
.extra-info{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #eee;display:flex;justify-content:space-around;padding:8px 0;box-shadow:0 -2px 6px rgba(0,0,0,0.05);z-index:10;}
.bottom-nav div{text-align:center;font-size:12px;color:var(--muted);cursor:pointer;display:flex;flex-direction:column;align-items:center;}
.bottom-nav .active{color:var(--primary);font-weight:600;}
.material-icons-outlined{font-size:20px;display:block;}
#loader {
  position: fixed; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  border: 6px solid #f3f3f3; border-top: 6px solid var(--primary);
  border-radius: 50%; width: 50px; height: 50px;
  animation: spin 1s linear infinite; z-index: 100;
}
@keyframes spin {0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); }}
</style>
</head>
<body>

<header>
  <span class="material-icons-outlined back-arrow" onclick="goBack()">arrow_back</span>
  <h1>My Favourites</h1>
</header>

<main>
  <div id="loader"></div>
  <section class="product-grid" id="productGrid" style="display:none;"></section>
</main>

<div class="bottom-nav">
  <div data-page="index.html"><span class="material-icons-outlined">home</span>Home</div>
  <div data-page="favourite.html"><span class="material-icons-outlined">favorite</span>Favourites</div>
  <div data-page="cart.html"><span class="material-icons-outlined">shopping_cart</span>Cart</div>
  <div data-page="buyer-profile.html"><span class="material-icons-outlined">person</span>Profile</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBuGBZ9wJ2i29fIR2YjtUHqAqa58hkKXug",
  authDomain: "mystockbd-2562f.firebaseapp.com",
  projectId: "mystockbd-2562f",
  storageBucket: "mystockbd-2562f.appspot.com",
  messagingSenderId: "502104908886",
  appId: "1:502104908886:web:ec887afe724c0f1a2f87f7",
  measurementId: "G-X85X54F9CK"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const productGrid = document.getElementById('productGrid');
const loader = document.getElementById('loader');

function showLoader(){ loader.style.display = 'block'; productGrid.style.display = 'none'; }
function hideLoader(){ loader.style.display = 'none'; productGrid.style.display = 'grid'; }

// Back function
function goBack(){ window.history.back(); }

// Get storeId from URL if exists
const urlParams = new URLSearchParams(window.location.search);
let currentStoreId = urlParams.get('storeId') || null;
if(currentStoreId) localStorage.setItem('currentStoreId', currentStoreId);

// Check login
auth.onAuthStateChanged(async user=>{
  if(!user){
    window.location.href = 'buyer-login.html';
    return;
  }
  await loadFavorites(user.uid);
});

// Load favorites
async function loadFavorites(userId){
  showLoader();
  try{
    const snap = await db.collection('users').doc(userId).collection('favorites').get();
    productGrid.innerHTML = '';
    let hasProducts = false;

    snap.forEach(doc=>{
      const product = doc.data();
      const storeId = product.storeId || currentStoreId;
      if(currentStoreId && storeId !== currentStoreId) return;

      hasProducts = true;
      const div = document.createElement('div');
      div.className = 'product-card';
      div.innerHTML = `
        <div class="product-image-wrapper">
          <img src="${product.mainImage}" alt="${product.title}">
          <span class="favorite-icon material-icons-outlined">favorite</span>
        </div>
        <div class="product-info">
          <h3>${product.title}</h3>
          <p class="price">‡ß≥${product.price}</p>
          <div class="extra-info">
          </div>
        </div>
      `;

      const favIcon = div.querySelector('.favorite-icon');
      favIcon.addEventListener('click', async e=>{
        e.stopPropagation();
        const productRef = db.collection('users').doc(userId).collection('favorites').doc(product.productId);
        await productRef.delete();
        div.remove();
        if(productGrid.children.length === 0) showNoFavorites();
      });

      div.addEventListener('click', ()=>{
        localStorage.setItem('selectedProduct', JSON.stringify(product));
        window.location.href = `product.html?storeId=${storeId}`;
      });

      productGrid.appendChild(div);
    });

    if(!hasProducts){
      showNoFavorites();
    }

    hideLoader();
  } catch(err){
    console.error(err);
    showNoFavorites("‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§");
    hideLoader();
  }
}

function showNoFavorites(message = "‡¶ï‡ßã‡¶®‡ßã ‡¶´‡ßá‡¶≠‡¶æ‡¶∞‡¶ø‡¶ü ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§") {
  productGrid.innerHTML = `
    <div style="
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 80vh;
      text-align: center;
      padding: 20px;
    ">
      <img src="https://i.postimg.cc/3rL3q8cD/Screenshot-2025-09-24-121738-removebg-preview.png" 
           alt="No Favorites" 
           style="max-width:400px; width:100%; height:auto;">
      <p style="margin-top:20px; color: var(--muted); font-size:18px;">${message}</p>
    </div>
  `;
}


// Bottom nav
const storeIdForNav = localStorage.getItem('currentStoreId');
document.querySelectorAll('.bottom-nav div').forEach(nav=>{
  const page = nav.dataset.page;
  nav.setAttribute("onclick", `window.location.href='${page}${storeIdForNav ? '?storeId='+storeIdForNav : ''}'`);
});

// Highlight active bottom nav
const currentPage = window.location.pathname.split('/').pop();
document.querySelectorAll('.bottom-nav div').forEach(nav=>{
  if(nav.dataset.page===currentPage) nav.classList.add('active');
});
</script>
</body>
</html>
